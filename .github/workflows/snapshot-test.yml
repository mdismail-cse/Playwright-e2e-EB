name: Snapshot Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

env:
  MAX_CONCURRENT: 5  # Number of parallel snapshot threads

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps chromium
      
    - name: Run snapshot tests
      id: snapshot_tests
      run: npm test
      continue-on-error: true
      
    - name: Read test report
      if: always()
      id: test_report
      run: |
        if [ -f test-results/snapshot-report-*.json ]; then
          REPORT_FILE=$(ls -t test-results/snapshot-report-*.json | head -1)
          echo "report_exists=true" >> $GITHUB_OUTPUT
          echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT
          
          # Extract key metrics
          SUCCESS=$(jq -r '.successfulSnapshots' "$REPORT_FILE")
          FAILED=$(jq -r '.failedSnapshots' "$REPORT_FILE")
          TOTAL=$(jq -r '.totalUrls' "$REPORT_FILE")
          DURATION=$(jq -r '.durationSeconds' "$REPORT_FILE")
          
          echo "success_count=$SUCCESS" >> $GITHUB_OUTPUT
          echo "failed_count=$FAILED" >> $GITHUB_OUTPUT
          echo "total_count=$TOTAL" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
        else
          echo "report_exists=false" >> $GITHUB_OUTPUT
        fi
      
    - name: Create SQA Summary
      if: always() && steps.test_report.outputs.report_exists == 'true'
      run: |
        cat << 'EOF' >> $GITHUB_STEP_SUMMARY
        # ðŸ“¸ Snapshot Test Results
        
        ## ðŸ“Š Summary
        
        | Metric | Value |
        |--------|-------|
        | âœ… Successful | ${{ steps.test_report.outputs.success_count }} |
        | âŒ Failed | ${{ steps.test_report.outputs.failed_count }} |
        | ðŸ“ Total URLs | ${{ steps.test_report.outputs.total_count }} |
        | â±ï¸ Duration | ${{ steps.test_report.outputs.duration }}s |
        | ðŸ“ˆ Success Rate | $(echo "scale=2; ${{ steps.test_report.outputs.success_count }} * 100 / ${{ steps.test_report.outputs.total_count }}" | bc)% |
        
        ## ðŸ“‹ Detailed Report
        
        The full JSON report is available in the artifacts.
        
        EOF
        
        # Add failed URLs if any
        if [ "${{ steps.test_report.outputs.failed_count }}" != "0" ]; then
          echo "## âŒ Failed URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          REPORT_FILE="${{ steps.test_report.outputs.report_file }}"
          jq -r '.failedUrls[] | "- **\(.url)**\n  - Error: \(.error)\n"' "$REPORT_FILE" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Generate HTML Report
      if: always() && steps.test_report.outputs.report_exists == 'true'
      run: npm run report:html
        
    - name: Upload snapshot report (JSON + HTML)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: snapshot-report
        path: |
          test-results/*.json
          test-results/*.html
        retention-days: 30
    
    - name: Comment PR with results
      if: github.event_name == 'pull_request' && steps.test_report.outputs.report_exists == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const reportFile = '${{ steps.test_report.outputs.report_file }}';
          const report = JSON.parse(fs.readFileSync(reportFile, 'utf8'));
          
          const successRate = ((report.successfulSnapshots / report.totalUrls) * 100).toFixed(2);
          
          let comment = `## ðŸ“¸ Snapshot Test Results\n\n`;
          comment += `| Metric | Value |\n`;
          comment += `|--------|-------|\n`;
          comment += `| âœ… Successful | ${report.successfulSnapshots} |\n`;
          comment += `| âŒ Failed | ${report.failedSnapshots} |\n`;
          comment += `| ðŸ“ Total URLs | ${report.totalUrls} |\n`;
          comment += `| â±ï¸ Duration | ${report.durationSeconds}s |\n`;
          comment += `| ðŸ“ˆ Success Rate | ${successRate}% |\n`;
          comment += `| ðŸš€ Speed | ${report.speedSnapshotsPerSecond} snapshots/sec |\n\n`;
          
          if (report.failedSnapshots > 0) {
            comment += `### âŒ Failed URLs\n\n`;
            report.failedUrls.forEach(item => {
              comment += `- **${item.url}**\n`;
              comment += `  - Error: ${item.error}\n`;
            });
          } else {
            comment += `### âœ… All snapshots passed!\n`;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  # Optional: Job to update snapshots automatically
  update-snapshots:
    runs-on: ubuntu-latest
    # Only run on schedule or manual trigger
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps chromium
      
    - name: Update all snapshots (parallel)
      run: npm run snapshot:all
      env:
        MAX_CONCURRENT: 5
      
    - name: Read snapshot report
      id: snapshot_report
      run: |
        REPORT_FILE=$(ls -t test-results/snapshot-report-*.json | head -1)
        SUCCESS=$(jq -r '.successfulSnapshots' "$REPORT_FILE")
        FAILED=$(jq -r '.failedSnapshots' "$REPORT_FILE")
        TOTAL=$(jq -r '.totalUrls' "$REPORT_FILE")
        DURATION=$(jq -r '.durationSeconds' "$REPORT_FILE")
        
        echo "success_count=$SUCCESS" >> $GITHUB_OUTPUT
        echo "failed_count=$FAILED" >> $GITHUB_OUTPUT
        echo "total_count=$TOTAL" >> $GITHUB_OUTPUT
        echo "duration=$DURATION" >> $GITHUB_OUTPUT
        
    - name: Create update summary
      run: |
        cat << 'EOF' >> $GITHUB_STEP_SUMMARY
        # ðŸ”„ Snapshot Update Results
        
        | Metric | Value |
        |--------|-------|
        | âœ… Updated | ${{ steps.snapshot_report.outputs.success_count }} |
        | âŒ Failed | ${{ steps.snapshot_report.outputs.failed_count }} |
        | ðŸ“ Total | ${{ steps.snapshot_report.outputs.total_count }} |
        | â±ï¸ Duration | ${{ steps.snapshot_report.outputs.duration }}s |
        | ðŸš€ Parallel Threads | ${{ env.MAX_CONCURRENT }} |
        EOF
      
    - name: Check for changes
      id: git-check
      run: |
        git diff --exit-code snapshot_latest/ || echo "changes=true" >> $GITHUB_OUTPUT
      
    - name: Commit and push updated snapshots
      if: steps.git-check.outputs.changes == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add snapshot_latest/
        git commit -m "chore: update ARIA snapshots [skip ci]

        Updated ${{ steps.snapshot_report.outputs.success_count }} snapshots in ${{ steps.snapshot_report.outputs.duration }}s
        Failed: ${{ steps.snapshot_report.outputs.failed_count }}"
        git push

name: Snapshot Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

env:
  MAX_CONCURRENT: 5  # Number of parallel snapshot threads

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps chromium
      
    - name: Validate snapshots against stored versions
      id: snapshot_validation
      run: npm run validate
      continue-on-error: true
      
    - name: Debug - List files
      if: always()
      run: |
        echo "=== Listing test-results directory ==="
        ls -la test-results/ || echo "test-results/ directory does not exist"
        echo ""
        echo "=== Listing all report files ==="
        find . -name "validation-report-*.json" -o -name "validation-report.html" | grep -v node_modules || echo "No report files found"
      
    - name: Read validation report
      if: always()
      id: validation_report
      run: |
        if [ -f test-results/validation-report-*.json ]; then
          REPORT_FILE=$(ls -t test-results/validation-report-*.json | head -1)
          echo "report_exists=true" >> $GITHUB_OUTPUT
          echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT
          
          # Extract key metrics
          PASSED=$(jq -r '.passedValidations' "$REPORT_FILE")
          FAILED=$(jq -r '.failedValidations' "$REPORT_FILE")
          MISSING=$(jq -r '.missingSnapshots' "$REPORT_FILE")
          ERRORS=$(jq -r '.errors' "$REPORT_FILE")
          TOTAL=$(jq -r '.totalUrls' "$REPORT_FILE")
          SUCCESS_RATE=$(jq -r '.successRate' "$REPORT_FILE")
          DURATION=$(jq -r '.durationSeconds' "$REPORT_FILE")
          
          echo "passed_count=$PASSED" >> $GITHUB_OUTPUT
          echo "failed_count=$FAILED" >> $GITHUB_OUTPUT
          echo "missing_count=$MISSING" >> $GITHUB_OUTPUT
          echo "errors_count=$ERRORS" >> $GITHUB_OUTPUT
          echo "total_count=$TOTAL" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
        else
          echo "report_exists=false" >> $GITHUB_OUTPUT
        fi
      
    - name: Create SQA Summary
      if: always() && steps.validation_report.outputs.report_exists == 'true'
      run: |
        cat << 'EOF' >> $GITHUB_STEP_SUMMARY
        # ðŸ§ª Snapshot Validation Results
        
        ## ðŸ“Š Summary
        
        | Metric | Value |
        |--------|-------|
        | âœ… Passed | ${{ steps.validation_report.outputs.passed_count }} |
        | âŒ Failed | ${{ steps.validation_report.outputs.failed_count }} |
        | ðŸ“„ Missing | ${{ steps.validation_report.outputs.missing_count }} |
        | âš ï¸ Errors | ${{ steps.validation_report.outputs.errors_count }} |
        | ðŸ“ Total URLs | ${{ steps.validation_report.outputs.total_count }} |
        | ðŸ“ˆ Success Rate | ${{ steps.validation_report.outputs.success_rate }}% |
        | â±ï¸ Duration | ${{ steps.validation_report.outputs.duration }}s |
        
        ## ðŸ“‹ Detailed Report
        
        The full JSON and HTML reports are available in the artifacts.
        
        EOF
        
        # Add issues if any
        TOTAL_ISSUES=$(($${{ steps.validation_report.outputs.failed_count }} + ${{ steps.validation_report.outputs.missing_count }} + ${{ steps.validation_report.outputs.errors_count }}))
        if [ "$TOTAL_ISSUES" != "0" ]; then
          echo "## âš ï¸ Issues Found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          REPORT_FILE="${{ steps.validation_report.outputs.report_file }}"
          
          if [ "${{ steps.validation_report.outputs.failed_count }}" != "0" ]; then
            echo "### âŒ Failed Validations" >> $GITHUB_STEP_SUMMARY
            jq -r '.failed[] | "- **\(.url)**\n  - Error: \(.error)\n"' "$REPORT_FILE" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.validation_report.outputs.missing_count }}" != "0" ]; then
            echo "### ðŸ“„ Missing Snapshots" >> $GITHUB_STEP_SUMMARY
            jq -r '.missing[] | "- **\(.url)**\n  - File: \(.filename)\n"' "$REPORT_FILE" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
    - name: Generate HTML Report
      if: always() && steps.validation_report.outputs.report_exists == 'true'
      run: node generate-validation-html-report.js
        
    - name: Upload snapshot report (JSON + HTML)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: snapshot-report
        path: test-results/
        retention-days: 30
    
    - name: Comment PR with results
      if: github.event_name == 'pull_request' && steps.validation_report.outputs.report_exists == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const reportFile = '${{ steps.validation_report.outputs.report_file }}';
          const report = JSON.parse(fs.readFileSync(reportFile, 'utf8'));
          
          const totalIssues = report.failedValidations + report.missingSnapshots + report.errors;
          
          let comment = `## ðŸ§ª Snapshot Validation Results\n\n`;
          comment += `| Metric | Value |\n`;
          comment += `|--------|-------|\n`;
          comment += `| âœ… Passed | ${report.passedValidations} |\n`;
          comment += `| âŒ Failed | ${report.failedValidations} |\n`;
          comment += `| ðŸ“„ Missing | ${report.missingSnapshots} |\n`;
          comment += `| âš ï¸ Errors | ${report.errors} |\n`;
          comment += `| ðŸ“ Total URLs | ${report.totalUrls} |\n`;
          comment += `| ðŸ“ˆ Success Rate | ${report.successRate}% |\n`;
          comment += `| â±ï¸ Duration | ${report.durationSeconds}s |\n\n`;
          
          if (totalIssues > 0) {
            if (report.failedValidations > 0) {
              comment += `### âŒ Failed Validations\n\n`;
              report.failed.forEach(item => {
                comment += `- **${item.url}**\n`;
                comment += `  - ${item.error}\n`;
              });
            }
            if (report.missingSnapshots > 0) {
              comment += `### ðŸ“„ Missing Snapshots\n\n`;
              report.missing.forEach(item => {
                comment += `- **${item.url}**\n`;
              });
            }
          } else {
            comment += `### âœ… All snapshots validated successfully!\n`;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  # Optional: Job to update snapshots automatically
  update-snapshots:
    runs-on: ubuntu-latest
    # Only run on schedule or manual trigger
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps chromium
      
    - name: Update all snapshots (parallel)
      run: npm run snapshot:all
      env:
        MAX_CONCURRENT: 5
      
    - name: Read snapshot report
      id: snapshot_report
      run: |
        REPORT_FILE=$(ls -t test-results/snapshot-report-*.json | head -1)
        SUCCESS=$(jq -r '.successfulSnapshots' "$REPORT_FILE")
        FAILED=$(jq -r '.failedSnapshots' "$REPORT_FILE")
        TOTAL=$(jq -r '.totalUrls' "$REPORT_FILE")
        DURATION=$(jq -r '.durationSeconds' "$REPORT_FILE")
        
        echo "success_count=$SUCCESS" >> $GITHUB_OUTPUT
        echo "failed_count=$FAILED" >> $GITHUB_OUTPUT
        echo "total_count=$TOTAL" >> $GITHUB_OUTPUT
        echo "duration=$DURATION" >> $GITHUB_OUTPUT
        
    - name: Create update summary
      run: |
        cat << 'EOF' >> $GITHUB_STEP_SUMMARY
        # ðŸ”„ Snapshot Update Results
        
        | Metric | Value |
        |--------|-------|
        | âœ… Updated | ${{ steps.snapshot_report.outputs.success_count }} |
        | âŒ Failed | ${{ steps.snapshot_report.outputs.failed_count }} |
        | ðŸ“ Total | ${{ steps.snapshot_report.outputs.total_count }} |
        | â±ï¸ Duration | ${{ steps.snapshot_report.outputs.duration }}s |
        | ðŸš€ Parallel Threads | ${{ env.MAX_CONCURRENT }} |
        EOF
      
    - name: Check for changes
      id: git-check
      run: |
        git diff --exit-code snapshot_latest/ || echo "changes=true" >> $GITHUB_OUTPUT
      
    - name: Commit and push updated snapshots
      if: steps.git-check.outputs.changes == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add snapshot_latest/
        git commit -m "chore: update ARIA snapshots [skip ci]

        Updated ${{ steps.snapshot_report.outputs.success_count }} snapshots in ${{ steps.snapshot_report.outputs.duration }}s
        Failed: ${{ steps.snapshot_report.outputs.failed_count }}"
        git push
